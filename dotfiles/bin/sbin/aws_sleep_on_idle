#!/bin/bash

sleep_file=/tmp/sleep.last
min_users=0

set -x

function sleep_now {
  echo "$(date) sleep now" >> /tmp/sleep.log
  iid=$(ec2-metadata -i | cut -d' ' -f2)
  aws ec2 stop-instances --instance-ids $iid --hibernate && rm $sleep_file
}

num_users=$(who -u | grep -v root | wc -l)
echo "num users $num_users"
(date; echo "num users $num_users"; who -u | grep -v root; )>> /tmp/sleep.log

if [[ -e $sleep_file ]]; then
  if [[ $num_users -gt $min_users ]]; then
    rm $sleep_file
  else
    now=$(date +%s)
    sleep_start=$(cat $sleep_file)
    sleep_diff=$(($now-$sleep_start))
    if [[ $sleep_diff -gt 600 ]]; then
      echo "$(date) idle for 10 mins" >> /tmp/sleep.log
      sleep_now
    fi
  fi
else
  if [[ $num_users -le $min_users ]]; then
    date +%s > $sleep_file
  fi
fi
    
